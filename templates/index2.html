<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Diffusion Image Generator</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
</head>
<body>

    <div class="container">
        <h1>Stable Diffusion Image Generator</h1>
        <form id="promptForm">
            <textarea id="prompt" name="prompt" placeholder="Enter prompt..." rows="4">a picture of a cartoon girl with long straight green hair and pretty eyes, sitting by the water, outdoors, (pink winter stockings:1.1), solo, looking at viewer, sitting, ponytail, black long shirt, blush, watercraft, open mouth, (dog ears:1.1), (fluffy dog tail:1.1), day, water, Maximum detailed textures, Maximum detailed shadows, Maximum detailed backgrounds, intensely saturated lighting effects, luminous reflections, vibrant color palette, glowing lights, surreal lighting, HDR effect</textarea>
            <textarea id="negativePrompt" name="negative_prompt" placeholder="Enter negative prompt..." rows="4">(nsfw, lowres, (bad), text, error, fewer, extra, missing, (worst quality), (low quality),jpeg artifacts, watermark, unfinished, displeasing, oldest, early, chromatic aberration, signature, extra digits, artistic error, username, scan, abstract, bad anatomy, bad hands, bad feet, bad hand, bad hands, bad finger, bad fingers, extra finger, extra fingers, split finger, split fingers, extra digits, fused arms, fused hands:1.6)</textarea>
            <div id="size-select">
                <label for="width" id="width-label">width:</label>
                <input type="number" id="width" name="width" placeholder="Width (px)" min="1" value="832">
                <label for="height" id="height-label">height:</label>
                <input type="number" id="height" name="height" placeholder="Height (px)" min="1" value="1216">
            </div>
            <div id="model-div">
                <label for="model">Select Model:</label>
                <select id="model" name="model">
                    <option value="https://huggingface.co/cagliostrolab/animagine-xl-3.1/blob/main/animagine-xl-3.1.safetensors">Animagine XL 3.1</option>
                    <option value="https://huggingface.co/SeaArtLab/SeaArt-Furry-XL-1.0/blob/main/furry-xl-4.0.safetensors">SeaArt Furry XL 4.0</option>
                </select>
            </div>
            <button type="submit">Generate Images</button>
        </form>        
        <div id="loading">GENERATING...</div> <!-- Loading text -->
        <div id="imageResults" class="image-container"></div>
    </div>

    <script>
        document.getElementById('promptForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const model = document.getElementById('model').value; 
        const prompt = document.getElementById('prompt').value;
        const negativePrompt = document.getElementById('negativePrompt').value;
        const width = document.getElementById('width').value;
        const height = document.getElementById('height').value;

        const loadingText = document.getElementById('loading');
        loadingText.style.display = 'block'; // Show loading text
        const imageContainer = document.getElementById('imageResults');
        imageContainer.innerHTML = '';  // Clear previous images

        // Open a new EventSource for streaming updates
        const source = new EventSource('/generate?' + new URLSearchParams({
            'model': model,
            'prompt': prompt,
            'negative_prompt': negativePrompt,
            'width': width,
            'height': height
        }));

        // Listen for each image as it's generated
        source.onmessage = function(event) {
            const data = JSON.parse(event.data);

            const imageCard = document.createElement('div');
            imageCard.classList.add('image-card');

            const img = document.createElement('img');
            img.src = data.img;
            imageCard.appendChild(img);

            const seedText = document.createElement('p');
            seedText.innerText = 'Seed: ' + data.seed;
            imageCard.appendChild(seedText);

            const downloadLink = document.createElement('a');
            downloadLink.href = `/download/${data.seed}?prompt=${encodeURIComponent(prompt)}&negative_prompt=${encodeURIComponent(negativePrompt)}`; 
            downloadLink.innerText = 'Download';
            downloadLink.classList.add('download-link');
            downloadLink.download = `image_${data.seed}.png`;
            imageCard.appendChild(downloadLink);

            imageContainer.appendChild(imageCard);
        };

        source.onerror = function() {
            console.error('Error generating images.');
            source.close();
            loadingText.style.display = 'none'; // Hide loading text
        };

        source.onopen = function() {
            loadingText.style.display = 'none'; // Hide loading text when generation starts
        };
    });

        let degree = 0; // Initialize degree

        function rotateGradient() {
            degree = (degree + 1) % 360; // Increment by 360 degrees
            document.body.style.background = `linear-gradient(${degree}deg, var(--bg-gradient-start), var(--bg-gradient-end))`;
        }

        setInterval(rotateGradient, 250); // Rotate every 1000 milliseconds (1 second)
    </script>
</body>
</html>