<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Image Generator</title>

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

</head>
<body>
    
    <div id="all">
        <h1>Stable Diffusion Image Generator</h1>
        <form id="generateForm">
            <label for="model">Select Model:</label>
            <select id="model" name="model" required>
                {% for model_name, model_url in model_options.items() %}
                    <option value="{{ model_url }}">{{ model_name }}</option>
                {% endfor %}
            </select><br>

            <label for="example_prompt">Example Prompts:</label>
            <select id="example_prompt" name="example_prompt">
                {% for prompt in prompt_examples.examples %}
                    <option value="{{ prompt }}">{{ prompt }}</option>
                {% endfor %}
            </select><br>

            <div id="prompt-div">
                <label for="prompt">Prompt:</label>
                <textarea id="prompt" name="prompt" required>1girl, cat girl, witch hat, forest, midnight, glowing tree, glowing eyes, glowing grass, dark maid dress, long vampire teeth, white skin, red hair, smile, cute, illustration, open mouth, vibrant colors, night, furry, fluffy, kemono</textarea><br>
            </div>

            <div id="negative-div">
                <label for="negative_prompt">Negative Prompt:</label>
                <textarea id="negative_prompt" name="negative_prompt">(nsfw, lowres, (bad), text, error, fewer, extra, missing, (worst quality), (low quality),jpeg artifacts,  watermark, unfinished, displeasing, oldest, early, chromatic aberration, signature, extra digits, artistic error, username, scan, abstract, bad anatomy, bad hands, bad feet, bad hand, bad hands, bad finger, bad fingers, extra finger, extra fingers, split finger, split fingers, extra digits, fused arms, fused hands:1.6)</textarea><br>
            </div>

            <div id="size-select">
                <label for="width">Width:</label>
                <input type="number" id="width" name="width" value="832" min="800"><br>

                <label for="height">Height:</label>
                <input type="number" id="height" name="height" value="1216" min="800"><br>
            </div>

            <div id="image-count">
                <label for="image_count">Number of Images:</label>
                <input type="number" id="image_count" name="image_count" value="4" min="1" required><br>
            </div>

            <div id="buttons">
                <button type="submit">Generate Images</button>
                <button type="button" id="stopButton">Stop Generation</button>
            </div>

            <div id="status">
                <p id="progress">Nothing Generating Yet</p>
                <progress id="progress-bar" value="0" max="100">0%</progress>
            </div>
        </form>
        <div id="images"></div>
    </div>

    <script>
        document.getElementById('generateForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            fetch('/generate', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.seed) {
                    globalSeed = data.seed;
                }
            })
            .catch(error => console.error('Error:', error));
        });

        // Use a polling mechanism to check for newly generated images
        setInterval(() => {
            fetch('/status')
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    const imagesDiv = document.getElementById('images');
                    imagesDiv.innerHTML = ''; // Clear previous images

                    const statusDiv = document.getElementById('status');
                    if (data.imgprogress == String) {
                        statusDiv.innerHTML = '<p id="progress">Progress: '+data.imgprogress+'</p><progress id="progress-bar" value="0" max="100">0%</progress>';
                    } else if (Number.isInteger(data.imgprogress)) {
                        statusDiv.innerHTML = '<p id="progress">Progress: '+data.imgprogress+'%</p><progress id="progress-bar" value="'+data.imgprogress+'" max="100">0%</progress>';
                    } else {
                        statusDiv.innerHTML = '<p id="progress">Progress: '+data.imgprogress+'</p><progress id="progress-bar" value="0" max="100">0%</progress>';
                    }
                    

                    // Check if images are available
                    if (data.images.length > 0) {
                        data.images.forEach(imgData => {
                            const img = document.createElement('img');
                            img.src = imgData.img; // The image URL
                            imagesDiv.appendChild(img);
                        });                        
                    } else {
                        console.log("No images generated yet.");
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }, 1000); // Check every 1 seconds

        document.getElementById('stopButton').addEventListener('click', function() {
            fetch('/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.status);
            })
            .catch(error => console.error('Error stopping generation:', error));
        });

        const selectElement = document.getElementById('example_prompt');
        const textareaElement = document.getElementById('prompt');

        // Add an event listener for the 'change' event on the select element
        selectElement.addEventListener('change', function() {
            // Set the value of the textarea to the selected option's value
            textareaElement.value = selectElement.value; // Update textarea with the selected prompt
        });

        // Optionally, set the initial value of the textarea to the first option's value
        textareaElement.value = selectElement.value;
    </script>
</body>
</html>
