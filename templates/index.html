<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Image Generator</title>

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

</head>
<body>
    
    <div id="all">
        <h1>Stable Diffusion Image Generator</h1>
        <form id="generateForm">
            <label for="model">Select Model:</label>
            <select id="model" name="model" required>
                {% for model_name, model_url in model_options.items() %}
                    <option value="{{ model_url }}">{{ model_name }}</option>
                {% endfor %}
            </select><br>

            <label for="example_prompt">Example Prompts:</label>
            <select id="example_prompt" name="example_prompt">
                {% for prompt in prompt_examples.examples %}
                    <option value="{{ prompt }}">{{ prompt }}</option>
                {% endfor %}
            </select><br>

            <div id="prompt-div">
                <label for="prompt">Prompt:</label>
                <textarea id="prompt" name="prompt" required>1girl, cat girl, witch hat, forest, midnight, glowing tree, glowing eyes, glowing grass, dark maid dress, long vampire teeth, white skin, red hair, smile, cute, illustration, open mouth, vibrant colors, night, furry, fluffy, kemono</textarea><br>
            </div>

            <div id="negative-div">
                <label for="negative_prompt">Negative Prompt:</label>
                <textarea id="negative_prompt" name="negative_prompt">(nsfw, lowres, (bad), text, error, fewer, extra, missing, (worst quality), (low quality),jpeg artifacts,  watermark, unfinished, displeasing, oldest, early, chromatic aberration, signature, extra digits, artistic error, username, scan, abstract, bad anatomy, bad hands, bad feet, bad hand, bad hands, bad finger, bad fingers, extra finger, extra fingers, split finger, split fingers, extra digits, fused arms, fused hands:1.6)</textarea><br>
            </div>

            <div id="size-select">
                <label for="width">Width:</label>
                <input type="number" id="width" name="width" value="832" min="800"><br>

                <label for="height">Height:</label>
                <input type="number" id="height" name="height" value="1216" min="800"><br>
            </div>

            <div id="image-count">
                <label for="image_count">Number of Images:</label>
                <input type="number" id="image_count" name="image_count" value="4" min="1" required><br>
            </div>

            <div id="buttons">
                <button type="submit">Generate Images</button>
                <button type="button" id="stopButton">Stop Generation</button>
            </div>

            <div id="status">
                <p id="progress">Nothing Generating Yet</p>
                <progress id="progress-bar" value="0" max="100">0%</progress>
            </div>
        </form>
        <label for="sensitive-toggle">Show Sensitive Images:</label>
        <div id="toggle-container" class="switch">
            <input type="checkbox" id="sensitive-toggle">
            <span class="slider round"></span>
        </div>
        <div id="images"></div>
    </div>

    <script>
        const existingImages = new Map(); // Store existing images with their seeds as keys
        const sensitiveToggle = document.getElementById('sensitive-toggle');

        document.getElementById('generateForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            fetch('/generate', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.seed) {
                    globalSeed = data.seed;
                }
            })
            .catch(error => console.error('Error:', error));

            // Clear existing images for new generation
            existingImages.clear();
            document.getElementById('images').innerHTML = ''; // Clear images display
        });

        setInterval(() => {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const imagesDiv = document.getElementById('images');
                    const statusDiv = document.getElementById('status');

                    // Update progress
                    if (Number.isInteger(data.imgprogress)){
                        statusDiv.innerHTML = `<p id="progress">Progress: ${data.imgprogress}%</p><progress id="progress-bar" value="${data.imgprogress}" max="100"></progress>`;
                    } else {
                        statusDiv.innerHTML = `<p id="progress">Progress: ${data.imgprogress}</p><progress id="progress-bar" value="0" max="100"></progress>`;
                    }
                    

                    // Check if images are available
                    if (data.images.length > 0) {
                        data.images.forEach(imgData => {
                            const key = imgData.seed; // Assuming seed is the unique identifier for the image

                            if (existingImages.has(key)) {
                                // Update existing image
                                const existingWrapper = existingImages.get(key);
                                const existingImg = existingWrapper.querySelector('img');
                                existingImg.src = imgData.img;

                                // Update the blur effect based on the toggle
                                updateBlurEffect(existingImg, imgData.sensitive);
                            } else {
                                // Create new image element if it doesn't exist
                                const wrapper = document.createElement('div'); // Create a wrapper div
                                wrapper.className = 'image-wrapper'; // Add a class for styling

                                const img = document.createElement('img');
                                img.src = imgData.img;

                                // Create sensitive text if necessary
                                if (imgData.sensitive) {
                                    const sensitiveText = document.createElement('p');
                                    sensitiveText.classList.add('centered');
                                    sensitiveText.innerHTML = imgData.sensitive;
                                    wrapper.appendChild(sensitiveText);
                                }

                                // Apply initial blur effect
                                updateBlurEffect(img, imgData.sensitive);

                                img.onclick = () => {
                                    if(isSensitive && !sensitiveToggle.checked){
                                        location.href = imgData.img;
                                    }
                                };
                                
                                wrapper.appendChild(img); // Add image to wrapper
                                imagesDiv.appendChild(wrapper); // Add wrapper to imagesDiv

                                existingImages.set(key, wrapper); // Store the wrapper in the map
                            }
                        });
                    } else {
                        console.log("No images generated yet.");
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }, 1000); // Check every 1 second

        document.getElementById('stopButton').addEventListener('click', function() {
            fetch('/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.status);
            })
            .catch(error => console.error('Error stopping generation:', error));
        });

        function updateBlurEffect(img, isSensitive) {
            if (isSensitive && !sensitiveToggle.checked) {
                img.classList.add('blurred'); // Add blur class if sensitive and toggle is off
            } else {
                img.classList.remove('blurred'); // Remove blur class if toggle is on or not sensitive
            }
        }

        sensitiveToggle.addEventListener('change', () => {
            if (sensitiveToggle.checked) {
                // Ask for confirmation if the user is 18+
                const isAdult = confirm('Are you 18 years or older?');
                
                if (!isAdult) {
                    // If user clicks "No", uncheck the toggle switch
                    sensitiveToggle.checked = false;
                    return; // Exit the function, no further action needed
                }
            }

            // Apply the blur effect based on the user's choice
            existingImages.forEach((wrapper) => {
                const img = wrapper.querySelector('img');
                const isSensitive = wrapper.querySelector('.centered') !== null; // Check if sensitive text exists
                updateBlurEffect(img, isSensitive);
            });
        });

        const selectElement = document.getElementById('example_prompt');
        const textareaElement = document.getElementById('prompt');

        // Add an event listener for the 'change' event on the select element
        selectElement.addEventListener('change', function() {
            textareaElement.value = selectElement.value; // Update textarea with the selected prompt
        });

        // Set the initial value of the textarea to the first option's value
        textareaElement.value = selectElement.value;
    </script>
</body>
</html>
